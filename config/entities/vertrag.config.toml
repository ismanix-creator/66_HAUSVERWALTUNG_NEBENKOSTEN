[entity]
name = "vertrag"
table_name = "vertraege"
label = "labels.entity.vertrag"
label_plural = "labels.entity.vertraege"
icon = "FileSignature"
primary_key = "id"

[entity.fields.id]
type = "uuid"
auto_generate = true
visible = false

[entity.fields.einheit_id]
type = "uuid"
required = true
reference = "einheit"
label = "labels.vertrag.einheit"

[entity.fields.mieter_id]
type = "uuid"
required = true
reference = "mieter"
label = "labels.vertrag.mieter"

[entity.fields.vertragsnummer]
type = "string"
max_length = 30
label = "labels.vertrag.vertragsnummer"

[entity.fields.typ]
type = "enum"
required = true
options = ["wohnraum", "gewerbe"]
label = "labels.vertrag.typ"
auto_from = "einheit.objekt.typ"

[entity.fields.beginn]
type = "date"
required = true
label = "labels.vertrag.beginn"

[entity.fields.ende]
type = "date"
label = "labels.vertrag.ende"
description = "Leer = unbefristet"

[entity.fields.kuendigungsfrist]
type = "integer"
default = 3
min = 1
max = 12
suffix = "Monate"
label = "labels.vertrag.kuendigungsfrist"

[entity.fields.kuendigung_zum]
type = "date"
label = "labels.vertrag.kuendigung_zum"

[entity.fields.gekuendigt_von]
type = "enum"
options = ["mieter", "vermieter"]
label = "labels.vertrag.gekuendigt_von"
visible_if = { field = "kuendigung_zum", is_set = true }

# === Mietkonditionen ===

[entity.fields.kaltmiete]
type = "currency"
required = true
min = 0
label = "labels.vertrag.kaltmiete"

[entity.fields.nebenkosten_vorauszahlung]
type = "currency"
required = true
min = 0
default = 0
label = "labels.vertrag.nebenkosten_vorauszahlung"

[entity.fields.heizkosten_vorauszahlung]
type = "currency"
min = 0
default = 0
label = "labels.vertrag.heizkosten_vorauszahlung"

[entity.fields.sonstige_vorauszahlung]
type = "currency"
min = 0
default = 0
label = "labels.vertrag.sonstige_vorauszahlung"
description = "z.B. Stellplatz, Garage"

# === MieterhÃ¶hung ===

[entity.fields.mietanpassung_typ]
type = "enum"
options = ["keine", "mietspiegel", "staffel", "index"]
default = "mietspiegel"
label = "labels.vertrag.mietanpassung_typ"
visible_if = { field = "typ", equals = "wohnraum" }

[entity.fields.staffelmiete]
type = "json"
label = "labels.vertrag.staffelmiete"
description = "Array: [{ab: date, kaltmiete: number}]"
visible_if = { field = "mietanpassung_typ", equals = "staffel" }

[entity.fields.indexmiete]
type = "json"
label = "labels.vertrag.indexmiete"
description = "{basisjahr, basisindex, schwelle_prozent}"
visible_if = { field = "mietanpassung_typ", equals = "index" }

[entity.fields.letzte_mieterhoehung]
type = "date"
label = "labels.vertrag.letzte_mieterhoehung"

[entity.fields.notiz]
type = "text"
label = "labels.common.notiz"

[entity.fields.erstellt_am]
type = "datetime"
auto_generate = true
visible_in_form = false

[entity.relations]
einheit = { type = "many_to_one", target = "einheit", foreign_key = "einheit_id" }
mieter = { type = "many_to_one", target = "mieter", foreign_key = "mieter_id" }
kaution = { type = "one_to_one", target = "kaution", foreign_key = "vertrag_id" }
zahlungen = { type = "one_to_many", target = "zahlung", foreign_key = "vertrag_id" }
sollstellungen = { type = "one_to_many", target = "sollstellung", foreign_key = "vertrag_id" }

[entity.computed]
gesamtmiete = { formula = "kaltmiete + nebenkosten_vorauszahlung + heizkosten_vorauszahlung + sonstige_vorauszahlung" }
ist_aktiv = { formula = "(ende is null or ende > now()) and kuendigung_zum is null" }
ist_gekuendigt = { formula = "kuendigung_zum is not null" }
naechste_mieterhoehung_moeglich = { formula = "add_months(letzte_mieterhoehung, 15)" }

[entity.validation]
ende_nach_beginn = { rule = "ende is null or ende > beginn", message = "labels.validation.ende_nach_beginn" }
kuendigung_logik = { rule = "kuendigung_zum is null or gekuendigt_von is not null", message = "labels.validation.kuendigung_von_fehlt" }
